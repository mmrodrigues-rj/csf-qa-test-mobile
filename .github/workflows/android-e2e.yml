name: Android E2E

on:
  push:
    branches: [ main, ci-setup, feat/* ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

env:
  ANDROID_APP_PATH: apps/android/native-demo-app.apk
  APPIUM_PORT: 4723

jobs:
  android-e2e:
    name: E2E on Android (Appium + Emulator)
    runs-on: macos-latest
    timeout-minutes: 35

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Appium 3
      - name: Install Appium 3
        run: |
          npm i -D appium@^3 --no-audit --no-fund
          npx appium -v

      # uiautomator2: instala/atualiza sem falhar se já estiver ok
            - name: Ensure uiautomator2 driver (install or install-if-missing)
        shell: bash
        run: |
          set -euo pipefail

          echo "== Appium drivers (antes) =="
          npx appium driver list --installed || true

          echo "== Tentando atualizar uiautomator2 =="
          set +e
          npx appium driver update uiautomator2
          RC=$?
          set -e

          if [ $RC -ne 0 ]; then
            echo "Update falhou (provavelmente não instalado). Tentando instalar…"
            set +e
            OUT="$(npx appium driver install uiautomator2 2>&1)"
            RC=$?
            set -e
            echo "$OUT"
            if [ $RC -ne 0 ]; then
              # Se o erro for "already installed", seguimos em frente
              if echo "$OUT" | grep -qi "already installed"; then
                echo "uiautomator2 já estava instalado — OK"
              else
                echo "Falha instalando uiautomator2"; exit $RC
              fi
            fi
          else
            echo "uiautomator2 atualizado (ou já estava na última versão) — OK"
          fi

          echo "== Appium drivers (depois) =="
          npx appium driver list --installed || true


      - name: Setup Java for Android tooling
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run Android emulator and E2E tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          target: google_apis
          profile: pixel_5
          disable-animations: true
          emulator-options: "-no-snapshot -no-boot-anim -noaudio"
          script: |
            set -euo pipefail

            echo "▶ Iniciando Appium em background…"
            npx appium --base-path / --port $APPIUM_PORT --log-level warn & APPIUM_PID=$!

            echo "▶ Aguardando Appium responder…"
            for i in {1..60}; do
              if curl -s "http://127.0.0.1:${APPIUM_PORT}/status" | grep -q "\"ready\":true"; then
                echo "Appium OK"
                break
              fi
              sleep 2
              if [ $i -eq 60 ]; then
                echo "Appium não iniciou a tempo"; kill $APPIUM_PID || true; exit 1
              fi
            done

            echo "▶ Executando testes E2E (Android)…"
            export PLATFORM=android
            export ANDROID_APP="$ANDROID_APP_PATH"

            TEST_STATUS=0
            npm run test:android || TEST_STATUS=$?

            echo "▶ Encerrando Appium…"
            kill $APPIUM_PID || true

            exit ${TEST_STATUS:-0}

      - name: Upload artifacts (if present)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts-android
          path: |
            reports/**
            logs/**
            **/wdio-*.log
          if-no-files-found: ignore
