name: android-e2e

on:
  push:
    branches: [ main, ci-setup, feat/* ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

env:
  ANDROID_APP_PATH: apps/android/native-demo-app.apk
  APPIUM_PORT: 4723

jobs:
  android-e2e:
    name: Android E2E
    runs-on: macos-13
    timeout-minutes: 40

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci

      # ★ Idempotente: nunca falha se o driver já existir
      - name: Install Appium + Android driver
        shell: bash
        run: |
          set -euo pipefail
          npm i -D appium@^3 --no-audit --no-fund
          npx appium -v

          echo "== Listing installed drivers =="
          npx appium driver list --installed || true

          if npx appium driver list --installed | grep -Eq '^uiautomator2(\s|@)'; then
            echo "uiautomator2 já instalado — tentando atualizar (não-fatal)"
            npx appium driver update uiautomator2 || true
          else
            echo "uiautomator2 não encontrado — instalando"
            npx appium driver install uiautomator2 || true
          fi

          echo "== Drivers instalados após step =="
          npx appium driver list --installed || true

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Run Android emulator and E2E tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: default
          arch: x86_64
          profile: pixel_3
          avd-name: e2e-avd
          force-avd-creation: true
          disable-animations: true
          emulator-boot-timeout: 1500
          emulator-options: >
            -no-window -no-snapshot -wipe-data -no-boot-anim -noaudio
            -camera-back none -camera-front none
            -gpu auto -netfast -timezone UTC
          script: |
            set -euo pipefail

            echo "▶ Start Appium"
            npx appium --base-path / --port "$APPIUM_PORT" --log-level warn & APPIUM_PID=$!

            for i in {1..60}; do
              if curl -sf "http://127.0.0.1:${APPIUM_PORT}/status" | grep -q '"ready":true'; then
                echo "Appium OK"; break
              fi
              sleep 2
              if [ $i -eq 60 ]; then
                echo "Appium não iniciou a tempo"; kill $APPIUM_PID || true; exit 1
              fi
            done

            export PLATFORM=android
            export ANDROID_APP="$ANDROID_APP_PATH"
            npm run test:android || TEST_STATUS=$?

            kill $APPIUM_PID || true
            exit ${TEST_STATUS:-0}

      - name: Upload artifacts (if present)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts-android
          path: |
            reports/**
            logs/**
            **/wdio-*.log
          if-no-files-found: ignore
