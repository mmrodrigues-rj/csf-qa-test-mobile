name: Mobile E2E (Android)

on:
  push:
    branches: [ main, ci-setup ]
  pull_request:
    branches: [ main ]

jobs:
  android-e2e:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        run: npm ci

      # Garante Appium + driver UIAutomator2 disponÃ­veis no runner
      - name: Install Appium + Android driver
        run: |
          npx appium -v || npm i -D appium
          npx appium driver install uiautomator2

      # Sobe Appium em background
      - name: Start Appium
        run: |
          npx appium --base-path /wd/hub --log-level info &
          sleep 5

      # Cria e executa emulador Android e roda os testes dentro dele
      - name: Run Android emulator and tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          profile: pixel_5
          emulator-options: "-no-window -no-snapshot -noaudio -gpu swiftshader_indirect"
          script: |
            adb devices
            echo "PLATFORM=android" >> $GITHUB_ENV
            npm run test:android:ci
