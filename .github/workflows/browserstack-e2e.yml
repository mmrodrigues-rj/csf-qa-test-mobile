name: BrowserStack E2E

on:
  push:
    branches: [ main, feat/* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Concurrency: cancela runs anteriores
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  PLATFORM: android
  BROWSERSTACK_PROJECT_NAME: CSF QA Test Mobile
  BROWSERSTACK_BUILD_NAME: "Build #${{ github.run_number }} - ${{ github.sha }}"

jobs:
  browserstack-android:
    name: Android E2E on BrowserStack
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install BrowserStack service
        run: npm install --save-dev @wdio/browserstack-service

      - name: Upload app to BrowserStack
        id: upload-app
        run: |
          echo "üì§ Uploading Android app to BrowserStack..."
          
          RESPONSE=$(curl -u "${{ secrets.BROWSERSTACK_USERNAME }}:${{ secrets.BROWSERSTACK_ACCESS_KEY }}" \
            -X POST "https://api-cloud.browserstack.com/app-automate/upload" \
            -F "file=@apps/android/native-demo-app.apk" \
            -F "custom_id=native-demo-app-${{ github.sha }}")
          
          echo "Response: $RESPONSE"
          
          APP_URL=$(echo $RESPONSE | jq -r '.app_url')
          echo "app_url=$APP_URL" >> $GITHUB_OUTPUT
          
          if [ -z "$APP_URL" ] || [ "$APP_URL" = "null" ]; then
            echo "‚ùå Failed to upload app to BrowserStack"
            exit 1
          fi
          
          echo "‚úÖ App uploaded successfully: $APP_URL"

      - name: Run E2E tests on BrowserStack
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          BROWSERSTACK_APP_URL: ${{ steps.upload-app.outputs.app_url }}
          PLATFORM: android
        run: |
          echo "üß™ Running tests on BrowserStack..."
          npx wdio run ./wdio.browserstack.conf.ts

      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-browserstack-android
          path: allure-results/
          if-no-files-found: warn
          retention-days: 30

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts-browserstack-android
          path: |
            reports/**
            logs/**
            **/wdio-*.log
          if-no-files-found: ignore
          retention-days: 7

  browserstack-ios:
    name: iOS E2E on BrowserStack
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: false  # Desabilitado por enquanto, habilite quando tiver o iOS app pronto

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install BrowserStack service
        run: npm install --save-dev @wdio/browserstack-service

      - name: Upload app to BrowserStack
        id: upload-app
        run: |
          echo "üì§ Uploading iOS app to BrowserStack..."
          
          # Zipar o .app antes de fazer upload
          cd apps/ios
          zip -r wdiodemoapp.zip Payload/
          cd ../..
          
          RESPONSE=$(curl -u "${{ secrets.BROWSERSTACK_USERNAME }}:${{ secrets.BROWSERSTACK_ACCESS_KEY }}" \
            -X POST "https://api-cloud.browserstack.com/app-automate/upload" \
            -F "file=@apps/ios/wdiodemoapp.zip" \
            -F "custom_id=wdiodemoapp-${{ github.sha }}")
          
          echo "Response: $RESPONSE"
          
          APP_URL=$(echo $RESPONSE | jq -r '.app_url')
          echo "app_url=$APP_URL" >> $GITHUB_OUTPUT
          
          if [ -z "$APP_URL" ] || [ "$APP_URL" = "null" ]; then
            echo "‚ùå Failed to upload app to BrowserStack"
            exit 1
          fi
          
          echo "‚úÖ App uploaded successfully: $APP_URL"

      - name: Run E2E tests on BrowserStack
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          BROWSERSTACK_APP_URL: ${{ steps.upload-app.outputs.app_url }}
          PLATFORM: ios
        run: |
          echo "üß™ Running tests on BrowserStack..."
          npx wdio run ./wdio.browserstack.conf.ts

      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-browserstack-ios
          path: allure-results/
          if-no-files-found: warn
          retention-days: 30
